<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src *;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printer Server Admin</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; padding: 20px; max-width: 800px; margin: 0 auto; color: #333; }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header { text-align: center; margin-bottom: 30px; }
        h1 { color: #1a1a1a; margin: 0; font-size: 2rem; }
        p.subtitle { color: #666; margin-top: 5px; }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e1e4e8; }
        h2 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #f0f0f0; padding-bottom: 12px; margin-bottom: 20px; font-size: 1.25rem; display: flex; align-items: center; gap: 10px; }
        
        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; font-size: 0.95em; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .input-group input[type="text"] { flex: 1; padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px; font-size: 15px; transition: border-color 0.2s; }
        .input-group input[type="text"]:focus { border-color: #3182ce; outline: none; box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2); }
        
        /* JSON ì—ë””í„° ìŠ¤íƒ€ì¼ */
        .json-editor-container { position: relative; }
        textarea { width: 100%; padding: 15px; height: 200px; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; border: 1px solid #cbd5e0; border-radius: 8px; background-color: #fafbfc; color: #24292e; resize: vertical; line-height: 1.5; }
        textarea:focus { border-color: #3182ce; outline: none; background-color: #fff; }
        .format-btn { position: absolute; top: 10px; right: 10px; background: #edf2f7; color: #4a5568; font-size: 12px; padding: 5px 10px; border-radius: 4px; border: 1px solid #cbd5e0; }
        .format-btn:hover { background: #e2e8f0; }

        /* ë²„íŠ¼ ê³µí†µ */
        button { cursor: pointer; border: none; border-radius: 6px; font-weight: 600; transition: all 0.2s; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        button:hover { transform: translateY(-1px); shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .test-btn { padding: 0 15px; background: #718096; color: white; min-width: 90px; }
        .test-btn:hover { background: #4a5568; }
        
        .drawer-btn { padding: 0 15px; background: #38a169; color: white; min-width: 120px; } /* ë…¹ìƒ‰ */
        .drawer-btn:hover { background: #2f855a; }

        .save-btn { background: #3182ce; color: white; padding: 15px; font-size: 16px; width: 100%; margin-top: 10px; box-shadow: 0 4px 6px rgba(49, 130, 206, 0.3); }
        .save-btn:hover { background: #2b6cb0; }

        /* ë©”ì‹œì§€ ë°•ìŠ¤ */
        .msg { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; text-align: center; font-weight: bold; animation: slideDown 0.3s ease-out; }
        .success { background: #c6f6d5; color: #22543d; border: 1px solid #9ae6b4; }
        .error { background: #fed7d7; color: #742a2a; border: 1px solid #feb2b2; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .helper-text { font-size: 0.85em; color: #718096; margin-top: -8px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <header>
        <h1>ğŸ–¨ï¸ Printer Server Admin</h1>
        <p class="subtitle">Manage network printers and receipt settings</p>
    </header>

    <div id="message" class="msg"></div>

    <form id="settingsForm">
        <div class="card">
            <h2>ğŸ“¡ Network Printers</h2>
            
            <label>Kitchen 1 (Food)</label>
            <div class="input-group">
                <input type="text" id="kitchen1_ip" placeholder="e.g. 192.168.50.3">
                <button type="button" class="test-btn" onclick="testPrinter('kitchen1_ip')">Test ğŸ–¨ï¸</button>
            </div>
            
            <label>Kitchen 2 (Shake/Drink)</label>
            <div class="input-group">
                <input type="text" id="kitchen2_ip" placeholder="e.g. 192.168.50.19">
                <button type="button" class="test-btn" onclick="testPrinter('kitchen2_ip')">Test ğŸ–¨ï¸</button>
            </div>
            
            <label>Receipt Printer (Counter)</label>
            <div class="input-group">
                <input type="text" id="receipt_ip" placeholder="e.g. 192.168.50.20">
                <button type="button" class="drawer-btn" onclick="testDrawer()">Open ğŸ’µ</button>
                <button type="button" class="test-btn" onclick="testPrinter('receipt_ip')">Test ğŸ–¨ï¸</button>
            </div>
            <p class="helper-text">* The Cash Drawer is connected via the Receipt Printer.</p>
        </div>

        <div class="card">
            <h2>ğŸ§¾ Receipt Design</h2>
            <label>Store Title (Header)</label>
            <div class="input-group">
                <input type="text" id="title" placeholder="THE COLLEGIATE GRILL">
            </div>
            
            <label>Footer Message</label>
            <div class="input-group">
                <input type="text" id="footer" placeholder="Thank You!">
            </div>
        </div>

        <div class="card">
            <h2>ğŸ”¤ Kitchen Abbreviations</h2>
            <p class="helper-text">Map long menu names to short codes for the kitchen. Must be valid JSON.</p>
            
            <div class="json-editor-container">
                <button type="button" class="format-btn" onclick="formatJSON()">âœ¨ Format JSON</button>
                <textarea id="abbreviations" placeholder='{
    "tomato": "T",
    "lettuce": "L"
}'></textarea>
            </div>
        </div>

        <button type="submit" class="save-btn">ğŸ’¾ Save All Settings</button>
    </form>

    <script>
        const API_URL = '/api/settings';

        // 1. ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadSettings() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();

                // í”„ë¦°í„° IP
                document.getElementById('kitchen1_ip').value = data.printers.kitchen1_ip || "";
                document.getElementById('kitchen2_ip').value = data.printers.kitchen2_ip || "";
                document.getElementById('receipt_ip').value = data.printers.receipt_ip || "";
                
                // ë””ìì¸
                document.getElementById('title').value = data.design.title || "";
                document.getElementById('footer').value = data.design.footer || "";

                // JSON ì•½ì–´ (ë³´ê¸° ì¢‹ê²Œ í¬ë§·íŒ…í•˜ì—¬ í‘œì‹œ)
                const abbrData = data.abbreviations || {};
                document.getElementById('abbreviations').value = JSON.stringify(abbrData, null, 4);
            } catch (e) {
                console.error(e);
                showMessage("Failed to load settings.", false);
            }
        }

        // 2. í”„ë¦°í„° í…ŒìŠ¤íŠ¸
        async function testPrinter(inputId) {
            const ip = document.getElementById(inputId).value;
            if (!ip) return showMessage("Please enter an IP address first.", false);

            const btn = document.querySelector(`button[onclick="testPrinter('${inputId}')"]`);
            const originalText = btn.innerText;
            setButtonLoading(btn, true);

            try {
                const res = await fetch('/api/test-printer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip })
                });
                const data = await res.json();

                if (data.success) showMessage(`âœ… Connection Successful! (${ip})`, true);
                else showMessage(`âŒ Connection Failed: ${data.error}`, false);
            } catch (e) {
                showMessage(`âŒ Network Error`, false);
            } finally {
                setButtonLoading(btn, false, originalText);
            }
        }

        // 3. ëˆí†µ ì—´ê¸° í…ŒìŠ¤íŠ¸
        async function testDrawer() {
            const ip = document.getElementById('receipt_ip').value;
            if (!ip) return showMessage("Please enter Receipt Printer IP first.", false);

            const btn = document.querySelector('.drawer-btn');
            const originalText = btn.innerText;
            setButtonLoading(btn, true);

            try {
                const res = await fetch('/api/printer/open-drawer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ printerIp: ip })
                });
                const data = await res.json();

                if (data.success) showMessage(`âœ… Drawer Signal Sent!`, true);
                else showMessage(`âŒ Failed to Open: ${data.message}`, false);
            } catch (e) {
                showMessage(`âŒ Network Error`, false);
            } finally {
                setButtonLoading(btn, false, originalText);
            }
        }

        // 4. JSON í¬ë§·íŒ… (Beautify) ë²„íŠ¼ ê¸°ëŠ¥
        function formatJSON() {
            const textarea = document.getElementById('abbreviations');
            try {
                const val = JSON.parse(textarea.value);
                textarea.value = JSON.stringify(val, null, 4);
                showMessage("âœ¨ JSON Formatted!", true);
            } catch (e) {
                showMessage("âš ï¸ Invalid JSON. Please check syntax.", false);
            }
        }

        // ìœ í‹¸: ë²„íŠ¼ ë¡œë”© ìƒíƒœ
        function setButtonLoading(btn, isLoading, text = "") {
            if (isLoading) {
                btn.dataset.originalText = btn.innerText; // ì›ë˜ í…ìŠ¤íŠ¸ ì €ì¥
                btn.innerText = "â³";
                btn.disabled = true;
            } else {
                btn.innerText = text || btn.dataset.originalText;
                btn.disabled = false;
            }
        }

        // 5. ì„¤ì • ì €ì¥ (Submit)
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            let abbrJson;
            
            // JSON ìœ íš¨ì„± ê²€ì‚¬
            try {
                const val = document.getElementById('abbreviations').value;
                abbrJson = val ? JSON.parse(val) : {};
            } catch (e) {
                showMessage("âŒ Invalid JSON in Abbreviations field. Please fix syntax.", false);
                return;
            }

            const payload = {
                printers: {
                    kitchen1_ip: document.getElementById('kitchen1_ip').value,
                    kitchen2_ip: document.getElementById('kitchen2_ip').value,
                    receipt_ip: document.getElementById('receipt_ip').value 
                },
                design: {
                    title: document.getElementById('title').value,
                    footer: document.getElementById('footer').value,
                    show_date: true
                },
                abbreviations: abbrJson
            };

            const btn = document.querySelector('.save-btn');
            setButtonLoading(btn, true);

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) showMessage("ğŸ’¾ Settings Saved Successfully!", true);
                else showMessage("âŒ Failed to save.", false);
            } catch (e) {
                showMessage("âŒ Error saving settings.", false);
            } finally {
                setButtonLoading(btn, false, "ğŸ’¾ Save All Settings");
            }
        });

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(text, isSuccess) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = 'msg ' + (isSuccess ? 'success' : 'error');
            msgDiv.style.display = 'block';
            
            // 3ì´ˆ í›„ ì‚¬ë¼ì§
            setTimeout(() => { 
                msgDiv.style.opacity = '0';
                setTimeout(() => {
                    msgDiv.style.display = 'none'; 
                    msgDiv.style.opacity = '1';
                }, 300);
            }, 3000);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        loadSettings();
    </script>
</body>
</html>