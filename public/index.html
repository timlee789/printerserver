<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src *;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printer Server Admin</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f4f9; padding: 20px; max-width: 800px; margin: 0 auto; }
        h1 { color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #555; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #666; font-size: 0.9em; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-group input[type="text"] { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        
        /* Î≤ÑÌäº Ïä§ÌÉÄÏùºÎßÅ */
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .test-btn { width: 80px; padding: 10px; background: #6c757d; color: white; }
        .drawer-btn { width: 110px; padding: 10px; background: #28a745; color: white; } /* ÎèàÌÜµ Î≤ÑÌäº (ÎÖπÏÉâ) */
        .save-btn { background: #007bff; color: white; padding: 12px 20px; font-size: 16px; width: 100%; margin-top: 10px; }

        textarea { width: 100%; padding: 10px; height: 150px; font-family: monospace; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        .msg { padding: 10px; border-radius: 5px; margin-bottom: 10px; display: none; text-align: center; font-weight: bold; }
        .success { background: #d4edda; color: #155724; display: block; }
        .error { background: #f8d7da; color: #721c24; display: block; }
    </style>
</head>
<body>
    <h1>üñ®Ô∏è Printer Server Admin</h1>
    <div id="message" class="msg"></div>

    <form id="settingsForm">
        <div class="card">
            <h2>1. Printer Network Connections</h2>
            
            <label>Kitchen Printer 1 IP (Main Food)</label>
            <div class="input-group">
                <input type="text" id="kitchen1_ip" placeholder="e.g. 192.168.50.3">
                <button type="button" class="test-btn" onclick="testPrinter('kitchen1_ip')">Test üñ®Ô∏è</button>
            </div>
            
            <label>Kitchen Printer 2 IP (Shake/Drink)</label>
            <div class="input-group">
                <input type="text" id="kitchen2_ip" placeholder="e.g. 192.168.50.19">
                <button type="button" class="test-btn" onclick="testPrinter('kitchen2_ip')">Test üñ®Ô∏è</button>
            </div>
            
            <label>Receipt Printer IP (Network)</label>
            <div class="input-group">
                <input type="text" id="receipt_ip" placeholder="e.g. 192.168.50.20">
                <button type="button" class="drawer-btn" onclick="testDrawer()">Open üíµ</button>
                <button type="button" class="test-btn" onclick="testPrinter('receipt_ip')">Test üñ®Ô∏è</button>
            </div>
            <p style="font-size: 0.8em; color: #888; margin-top: -10px;">* The Cash Drawer is connected to the Receipt Printer.</p>
        </div>

        <div class="card">
            <h2>2. Receipt Design</h2>
            <label>Receipt Title (Header)</label>
            <div class="input-group">
                <input type="text" id="title" placeholder="Store Name">
            </div>
            
            <label>Receipt Footer Message</label>
            <div class="input-group">
                <input type="text" id="footer" placeholder="Thank You Message">
            </div>
        </div>

        <div class="card">
            <h2>3. Custom Abbreviations (JSON)</h2>
            <textarea id="abbreviations" placeholder='{ "tomato": "T" }'></textarea>
        </div>

        <button type="submit" class="save-btn">üíæ Save Settings</button>
    </form>

    <script>
        const API_URL = '/api/settings';

        // Load Settings
        async function loadSettings() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();

                document.getElementById('kitchen1_ip').value = data.printers.kitchen1_ip || "";
                document.getElementById('kitchen2_ip').value = data.printers.kitchen2_ip || "";
                document.getElementById('receipt_ip').value = data.printers.receipt_ip || "";
                
                document.getElementById('title').value = data.design.title || "";
                document.getElementById('footer').value = data.design.footer || "";

                // JSONÏù¥ ÏóÜÏúºÎ©¥ Îπà Í∞ùÏ≤¥ {} ÌëúÏãú
                const abbrData = data.abbreviations || {};
                document.getElementById('abbreviations').value = JSON.stringify(abbrData, null, 4);
            } catch (e) {
                console.error(e);
                showMessage("Failed to load settings.", false);
            }
        }

        // üñ®Ô∏è ÌîÑÎ¶∞ÌÑ∞ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
        async function testPrinter(inputId) {
            const ip = document.getElementById(inputId).value;
            if (!ip) return showMessage("Please enter an IP address first.", false);

            const btn = document.querySelector(`button[onclick="testPrinter('${inputId}')"]`);
            const originalText = btn.innerText;
            setButtonLoading(btn, true);

            try {
                const res = await fetch('/api/test-printer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip })
                });
                const data = await res.json();

                if (data.success) showMessage(`‚úÖ Connection Successful! (${ip})`, true);
                else showMessage(`‚ùå Connection Failed: ${data.error}`, false);
            } catch (e) {
                showMessage(`‚ùå Network Error`, false);
            } finally {
                setButtonLoading(btn, false, originalText);
            }
        }

        // üíµ ‚ú® [Ï∂îÍ∞Ä] ÎèàÌÜµ Ïó¥Í∏∞ ÌÖåÏä§Ìä∏
        async function testDrawer() {
            const ip = document.getElementById('receipt_ip').value;
            if (!ip) return showMessage("Please enter Receipt Printer IP first.", false);

            const btn = document.querySelector('.drawer-btn');
            const originalText = btn.innerText;
            setButtonLoading(btn, true);

            try {
                // Ïö∞Î¶¨Í∞Ä ÎßåÎì† API Ìò∏Ï∂ú
                const res = await fetch('/api/printer/open-drawer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ printerIp: ip })
                });
                const data = await res.json();

                if (data.success) showMessage(`‚úÖ Drawer Signal Sent!`, true);
                else showMessage(`‚ùå Failed to Open: ${data.message}`, false);
            } catch (e) {
                showMessage(`‚ùå Network Error`, false);
            } finally {
                setButtonLoading(btn, false, originalText);
            }
        }

        // Î≤ÑÌäº Î°úÎî© ÏÉÅÌÉú Ïú†Ìã∏
        function setButtonLoading(btn, isLoading, text = "") {
            if (isLoading) {
                btn.innerText = "‚è≥";
                btn.disabled = true;
            } else {
                btn.innerText = text;
                btn.disabled = false;
            }
        }

        // Save Settings
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            let abbrJson;
            try {
                const val = document.getElementById('abbreviations').value;
                abbrJson = val ? JSON.parse(val) : {};
            } catch (e) {
                showMessage("Invalid JSON in Abbreviations field.", false);
                return;
            }

            const payload = {
                printers: {
                    kitchen1_ip: document.getElementById('kitchen1_ip').value,
                    kitchen2_ip: document.getElementById('kitchen2_ip').value,
                    receipt_ip: document.getElementById('receipt_ip').value 
                },
                design: {
                    title: document.getElementById('title').value,
                    footer: document.getElementById('footer').value,
                    show_date: true
                },
                abbreviations: abbrJson
            };

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) showMessage("Settings Saved Successfully!", true);
                else showMessage("Failed to save.", false);
            } catch (e) {
                showMessage("Error saving settings.", false);
            }
        });

        function showMessage(text, isSuccess) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = 'msg ' + (isSuccess ? 'success' : 'error');
            // 3Ï¥à ÌõÑ Î©îÏãúÏßÄ ÏÇ¨ÎùºÏßê
            setTimeout(() => { 
                msgDiv.style.display = 'none'; 
                msgDiv.className = 'msg'; 
            }, 3000);
            msgDiv.style.display = 'block';
        }

        loadSettings();
    </script>
</body>
</html>